<!DOCTYPE html>
<html>
    <head>
        <%- include('public/head'); -%>
        <style>
            div.item {
                border: 2px solid #000;
                width: 1050px;
                height: 200px;
                margin:10px auto;
                padding: 25px;
                box-sizing: border-box;
            }

            div.item img{
                float:left;
                margin-right: 20px;
            }

            div.item h1{
                margin-top: 0;
            }
        </style>
    </head>

    <body>
        <div class = "container">
            <%- include('public/header'); -%>

            <%- include('public/navbar'); -%>

            <div class = "content">
                <h1><i class="fa fa-shopping-cart" aria-hidden="true"></i>我的購物車</h1>
                <% if(items.length > 0){ %>
                    <div style="background: var(--main-color); border: var(--darker-color) solid 5px ; padding: 5%;box-sizing: border-box;">
                        <% for(var i=0; i<items.length; i++) {%>
                            <div class = "section" style="margin: 0 auto; height: auto">
                                <h2>賣家: <%= items[i][0].nickname %></h2>
                                <% for(var j=0; j<items[i].length; j++) {%>
                                    <a href="/product/<%= items[i][j].prono %>"> 
                                        <div class = "section" style="margin: 0 auto;">
                                            <img src = "/<%= items[i][j].picture %>" height="100%">
                                            <div class = "right">
                                                <span>商品名稱: <%= items[i][j].proname %></span>
                                                <br/>
                                                <span>售價: <%= items[i][j].price %>$</span>
                                                <br/>
                                                <span>商品介紹: <%= items[i][j].description %></span>
                                                <br/>
                                                <span>上架日期: <%= items[i][j].date %></span>
                                            </div>
                                        </div>
                                    </a>
                                <% } %>
                                <h2>選擇付費方式:</h2>
                                <span id='variableJSON' hidden>
                                    <%= JSON.stringify(product); %>
                                </span>
                                <% for(var j=0; j<items[i].length; j++) {%>    <% } %>
                                <div class="button-group">
                                    <% for(var j=0; j<items[i][0].payment.length; j++) {%>
                                        <label class="button" style="background:#444;display:inline-grid;cursor: pointer;-webkit-appearance: button-bevel;" for="<%= items[i][0].memno %><%= items[i][0].payment[j].payno %>">
                                            <input name="radio[<%= i %>]" id="<%= items[i][0].memno %><%= items[i][0].payment[j].payno %>" value="<%= items[i][0].payment[j].payno %>"" style="margin: 0 auto;display: none" type="radio"><span style="margin: auto"><%= items[i][0].payment[j].payname %></span>
                                        </label>
                                    <% } %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                    <div style="float: right">
                        <h1 style="float: left;margin-top: 1em;">總共<%= sum %>$</h1>
                        <form action = "/shoppingCart/confirm" method = "post">
                            <input name="data" id='data' hidden>
                            <div class="value" style="margin-left: 1em;margin-top: 1em;float: right;"><input class="button" type="submit" value="確認"></div>
                        </form>
                    </div>
                <% }else{ %>
                    <h3>購物車還是空空的!</h3>
                    <p>何不去逛逛有什麼你想買的呢?</p>
                <% } %>
            </div>

            <%- include('public/footer'); -%>
        </div>
    </body>

    <script src = "http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <script>
        var variableJSON = JSON.parse($('#variableJSON').text());
        $("#variableJSON").remove();
        
        $(':input[type=radio]').each(function(){
            $(this).parent().css("background","#444");
            $(':input[type="submit"]').prop('disabled', true);
            $(':input[type="submit"]').css("background","#444");
        })
        $(':input').change(function(){
            $(':input[type=radio]').each(function(){
                $(this).parent().css("background","#444");
                if($(this).prop("checked")) {
                    $(this).parent().css("background","var(--green)");
                }
            })
            var chek = true;
            if ($('div.button-group:not(:has(:radio:checked))').length) {
                var chek = false;
            }

            if (chek) {
                payno = [];
                $('div.button-group').each(function(){
                    $(this).children().children().each(function(){
                        if ($(this).prop("checked")) {
                            payno.push($(this).val());
                        }
                    })
                })
                var newPost = []
                for (var i = 0; i < variableJSON.length; i++) {
                    for (var j = 0; j < variableJSON[i].length; j++) {
                        if (j == 0) {
                            newPost.push({payno:payno[i],prono:[variableJSON[i][j]]})
                        }
                        else {
                            newPost[i].prono.push(variableJSON[i][j]);
                        }
                    }
                }
                console.log(newPost)
                console.log(JSON.stringify(newPost))
                $('#data').val(JSON.stringify(newPost))

                $(':input[type="submit"]').prop('disabled', false);
                $(':input[type="submit"]').css("background","var(--green)");
            }
            else {
                $(':input[type="submit"]').prop('disabled', true);
                $(':input[type="submit"]').css("background","#444");
            }
        })
    </script>
</html>
